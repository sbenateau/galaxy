<tool id="row-simple-operation" name="Row operations">
    <requirements>
        <requirement type="package" version="1.12.2">r-data.table</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        cat '$script' &&
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
            ## Setup R error handling to go to stderr
            options(show.error.messages=F, error=function(){cat(geterrmessage(), file=stderr()); q("no",1,F)})

            ## Unify locale settings
            loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

            ## Import library
            library(data.table)

            ## Import file
            input <- fread('$input')

            ## prepare output file
            output <- input[ , c($advanced.keep)]

            ##Keep the selected columns
            inputSelect <- input[ , c($advanced.include)]

            ## Add new column
            #for $i, $s in enumerate($operation)
            rank_of_series=$i

            #if $s.outputOperation == "mean"
                result <- rowMeans(inputSelect, na.rm = TRUE)
            #elif $s.outputOperation == "sum"
                result <- rowSums(inputSelect, na.rm = TRUE)
            #elif $s.outputOperation == "sd"
                result <- rowSds(inputSelect, na.rm = TRUE)
            #elif $s.outputOperation == "countAbove0"
                inputSelectZero <- inputSelect
                inputSelectZero[inputSelectZero > 0] <- 1
                result <- rowSums(inputSelectZero, na.rm = TRUE)
            #end if

            #if $addToData == "TRUE"
                output <- data.frame(output, res = result)
                colnames(output)[ncol(output)] <- '$s.outputName'
            #else
                output <- data.frame(res = result)
                colnames(output) <- '$s.outputName'
            #end if
            #end for

            write.table(output, file="result", row.names=FALSE, sep="\t")

        ]]></configfile>
    </configfiles>

    <inputs>
        <param format="tabular,csv" name="input" type="data" label="Input file" />
        <param falsevalue="FALSE" label="Add column to original dataset" name="addToData" truevalue="TRUE" type="boolean" />
        <section name="advanced" title="Advanced options" expanded="false">
        <param name="include" label="Columns included" type="data_column" data_ref="input" numerical="false" multiple = "true" />
        <param name="keep" label="Columns to keep in the dataset" type="data_column" data_ref="input" numerical="false" multiple = "true" />
        </section>
        <repeat name="operation" title="Operation">
            <param name="outputName" type="text" value="Result" label="Name of the resulting column" />
            <param name="outputOperation" type="select" label="choose the operation to perform">
                <option value="sum" selected="true">Sum</option>
                <option value="mean">Mean</option>
                <option value="sd">Standart deviation</option>
                <option value="countAbove0">Count of values above 0</option>
            </param>
        </repeat>
    </inputs>
    <outputs>
        <data format="tabular" name="output" from_work_dir="result"/>
    </outputs>
    <tests>
        <test>
            <param name="input" value="input-lubridate.tabular"/>
            <param name="addToData" value="TRUE"/>
            <param name="column" value="3"/>
            <param name="outputName" value="date"/>
            <param name="inputDateFormat" value="DMY"/>
            <param name="outputDateFormat" value="full"/>
            <output name="output" file="out-lubridate.tabular"/>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

This tool converts dates to standart format
 * choose input format
 * choose output format

**Example**

input dataset ::

 ID   dateIn
 1   12/10/2019
 2   12.10.2019
 3   12-10-2019
 4 12//10//2019
 5   12/10*2019

 Parameters :

 Add column : No
 insert serie
 Number of the column to parse: 2
 Name of the resulting column: date
 choose input date format: dmy
 choose output date format: full
 insert serie
 Number of the column to parse: 2
 Name of the resulting column: Day of the year
 choose input date format: dmy
 choose output date format: Day of the year

Result ::

    date     Day of the year
 2019-10-12       285
 2019-10-12       285
 2019-10-12       285
 2019-10-12       285
 2019-10-12       285

    ]]></help>
</tool>
